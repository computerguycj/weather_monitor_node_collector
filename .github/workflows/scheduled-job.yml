name: Daily Node Collector Job

on:
  schedule:
    - cron: '1 7 * * *'  # Daily at 7:01 UTC
  workflow_dispatch:     # Optional: manual trigger

jobs:
  run-node-collector:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build container locally
        run: docker build -t node-collector .

      - name: Run container
        run: docker run --rm -e DATABASE_URL="${{ secrets.DATABASE_URL }}" node-collector

      - name: Debug Puppeteer inside container
        run: |
          docker run --rm node-collector bash -c "
            echo 'Resolved puppeteer-core path:'
            node -e \"console.log(require.resolve('puppeteer-core'))\"

            echo 'Chromium executable path:'
            node -e \"
              const puppeteer = require('puppeteer-core');
              puppeteer.launch({
                executablePath: '/usr/bin/chromium',
                headless: true,
                args: ['--no-sandbox', '--disable-setuid-sandbox']
              }).then(browser => {
                console.log('✅ Chromium launched successfully');
                return browser.close();
              }).catch(err => {
                console.error('❌ Failed to launch Chromium:', err);
                process.exit(1);
              });
            \"

            echo 'Does Chromium exist?'
            ls -l /usr/bin/chromium || echo 'Chromium not found'
          "
